name: angle-build

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "Run ID that produced the angle-src.tgz artifact"
        required: true
        default: "19175891700"
      artifact_name:
        description: "Artifact name to download (exact)"
        required: true
        default: "angle-src.tgz"
      config:
        description: "Build config"
        required: true
        default: "Release"   # or Debug
        type: choice
        options: [Release, Debug]

jobs:
  build-angle:
    runs-on: windows-2022
    env:
      ANGLE_ROOT: ${{ github.workspace }}\work\angle
      DEPOT_TOOLS: ${{ github.workspace }}\work\depot_tools
      # Force local VS toolchain (we don't have access to Google's GCS buckets on GitHub runners)
      DEPOT_TOOLS_WIN_TOOLCHAIN: "0"
      GCLIENT_PY3: "1"
      # GN args will be set later
    steps:
      - name: Checkout stub (not strictly necessary)
        uses: actions/checkout@v4

      - name: Prepare work dirs
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\work" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\out"  | Out-Null

      - name: Define tiny retry helper (PowerShell)
        shell: pwsh
        run: |
          $fn = @'
          param([string]$Cmd, [int]$Max=5, [int]$Delay=15)
          for ($i=1; $i -le $Max; $i++) {
            Write-Host ("Retry {0}/{1}: {2}" -f $i, $Max, $Cmd)
            try {
              & cmd /c $Cmd
              if ($LASTEXITCODE -eq 0) { return 0 }
            } catch { }
            Start-Sleep -Seconds $Delay
          }
          throw ("Command failed after retry: {0}" -f $Cmd)
          '@
          $fn | Out-File -FilePath "$env:GITHUB_WORKSPACE\retry.ps1" -Encoding ASCII

      - name: Download angle-src.tgz artifact (from prior run)
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: work
          run-id: ${{ inputs.run_id }}

      - name: Verify and extract angle-src.tgz
        shell: pwsh
        run: |
          Set-Location "$env:GITHUB_WORKSPACE\work"
          if (-not (Test-Path ".\angle-src.tgz")) {
            throw "angle-src.tgz not found in work/ (artifact name mismatch?)"
          }
          # Extract .tgz with built-in tar
          tar -xf .\angle-src.tgz
          # Expect the unpacked tree root to be "angle"
          if (-not (Test-Path ".\angle")) {
            throw "Extracted archive did not produce 'angle' directory."
          }

      - name: Fetch depot_tools (minimal)
        shell: pwsh
        run: |
          Set-Location "$env:GITHUB_WORKSPACE\work"
          if (-not (Test-Path ".\depot_tools")) {
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git depot_tools
          }
          # Put depot_tools on PATH for subsequent steps
          echo "$env:DEPOT_TOOLS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Pin git settings for large trees
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global core.filemode false
          git config --global core.fscache true
          git config --global core.preloadindex true
          git config --global depot-tools.allowGlobalGitConfig false

      - name: gclient sync (populate DEPS)
        shell: pwsh
        run: |
          Set-Location "$env:ANGLE_ROOT"
          # If the .gclient file isn't present (depending on how the tgz was created),
          # create a trivial one that points to the current directory.
          if (-not (Test-Path ".gclient")) {
            $spec = @"
solutions = [
  {
    \"name": \".\",
    \"url": \"https://chromium.googlesource.com/angle/angle.git\",
    \"deps_file\": \"DEPS\",
    \"managed\": False,
    \"custom_vars\": {},
  },
]
"@
            $spec | Out-File -FilePath ".gclient" -Encoding ASCII
          }
          # Run sync with retries
          & "$env:GITHUB_WORKSPACE\retry.ps1" "gclient sync -D --nohooks"

      - name: Runhooks (regenerate GN files for local toolchain)
        shell: pwsh
        run: |
          Set-Location "$env:ANGLE_ROOT"
          & "$env:GITHUB_WORKSPACE\retry.ps1" "gclient runhooks"

      - name: Generate GN files (x64)
        shell: pwsh
        run: |
          Set-Location "$env:ANGLE_ROOT"
          $isDebug = ("${{ inputs.config }}" -eq "Debug")
          if ($isDebug) {
            $gn = 'is_debug=true is_component_build=false target_cpu="x64" angle_enable_vulkan=false'
          } else {
            $gn = 'is_debug=false is_component_build=false target_cpu="x64" angle_enable_vulkan=false'
          }
          & "$env:GITHUB_WORKSPACE\retry.ps1" "gn gen out/Win64${{ inputs.config }} --args='$gn'"

      - name: Build ANGLE (libEGL, libGLESv2)
        shell: pwsh
        run: |
          Set-Location "$env:ANGLE_ROOT"
          & "$env:GITHUB_WORKSPACE\retry.ps1" "autoninja -C out/Win64${{ inputs.config }} libEGL libGLESv2"

      - name: Collect outputs
        shell: pwsh
        run: |
          $out = Join-Path $env:ANGLE_ROOT "out\Win64${{ inputs.config }}"
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\out\bin"    | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\out\lib"    | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\out\include"| Out-Null

          Copy-Item "$out\libEGL.dll"     "$env:GITHUB_WORKSPACE\out\bin\" -Force
          Copy-Item "$out\libGLESv2.dll"  "$env:GITHUB_WORKSPACE\out\bin\" -Force
          # import libs
          if (Test-Path "$out\libEGL.lib")     { Copy-Item "$out\libEGL.lib"     "$env:GITHUB_WORKSPACE\out\lib\" -Force }
          if (Test-Path "$out\libGLESv2.lib")  { Copy-Item "$out\libGLESv2.lib"  "$env:GITHUB_WORKSPACE\out\lib\" -Force }

          # Public headers from the source tree
          Copy-Item "$env:ANGLE_ROOT\include" "$env:GITHUB_WORKSPACE\out\include" -Recurse -Force

      - name: Upload ANGLE binaries and headers
        uses: actions/upload-artifact@v4
        with:
          name: angle-win64-${{ inputs.config }}
          path: |
            out/bin/**
            out/lib/**
            out/include/**
