name: angle-fetch

on:
  workflow_dispatch:  # run manually from the Actions tab

jobs:
  fetch:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Checkout (empty)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare clean workspace
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $wd = Join-Path $env:GITHUB_WORKSPACE 'work'
          if (Test-Path $wd) { Remove-Item -Recurse -Force $wd }
          New-Item -ItemType Directory -Path $wd | Out-Null
          "WORKDIR=$wd" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Fetch depot_tools
        shell: pwsh
        working-directory: ${{ env.WORKDIR }}
        run: |
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          "$PWD\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure gclient (unmanaged, explicit name)
        shell: pwsh
        working-directory: ${{ env.WORKDIR }}
        run: |
          gclient --version
          gclient config --unmanaged --name angle https://chromium.googlesource.com/angle/angle.git

      - name: Sync ANGLE (with simple retry)
        shell: pwsh
        working-directory: ${{ env.WORKDIR }}
        run: |
          $retries = 4
          for ($i=1; $i -le $retries; $i++) {
            Write-Host "gclient sync attempt $i of $retries"
            try {
              gclient sync -D
              if ($LASTEXITCODE -eq 0) { break }
            } catch { }
            if ($i -eq $retries) { throw "gclient sync failed after $retries attempts" }
            Start-Sleep -Seconds (30 * $i)
          }

      - name: Zip angle/ tree
        shell: pwsh
        working-directory: ${{ env.WORKDIR }}
        run: |
          Compress-Archive -Path .\angle -DestinationPath angle-src.zip -Force
          Get-ChildItem angle-src.zip | Format-Table Name,Length

      - name: Upload artifact (ANGLE source)
        uses: actions/upload-artifact@v4
        with:
          name: angle-src
          path: ${{ env.WORKDIR }}\angle-src.zip
          if-no-files-found: error
          retention-days: 7
