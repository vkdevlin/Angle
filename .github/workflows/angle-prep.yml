name: angle-prep

on:
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read

jobs:
  prep:
    runs-on: windows-latest
    env:
      REPO: vkdevlin/Angle
      RUN_ID: 19175891700          # <-- your successful fetch run
      ART_NAME: angle-src.tgz      # <-- exact artifact name to pull

    steps:
      - name: Make work dir
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\work" | Out-Null

      - name: Download artifact (REST API)
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $headers = @{
            Authorization          = "Bearer $env:GH_TOKEN"
            "X-GitHub-Api-Version" = "2022-11-28"
            Accept                 = "application/vnd.github+json"
          }

          # 1) List artifacts on the target run
          $listUrl = "https://api.github.com/repos/$env:REPO/actions/runs/$env:RUN_ID/artifacts?per_page=100"
          $resp = Invoke-RestMethod -Headers $headers -Uri $listUrl -Method GET

          if (-not $resp.artifacts) {
            throw "No artifacts found on run $env:RUN_ID."
          }

          $artifact = $resp.artifacts | Where-Object { $_.name -eq $env:ART_NAME } | Select-Object -First 1
          if (-not $artifact) {
            $found = ($resp.artifacts.name -join ', ')
            throw "Artifact '$env:ART_NAME' not found on run $env:RUN_ID. Found: $found"
          }

          # 2) Download ZIP of that artifact id
          $zipUrl  = "https://api.github.com/repos/$env:REPO/actions/artifacts/$($artifact.id)/zip"
          $zipPath = Join-Path "$env:GITHUB_WORKSPACE\work" "$($env:ART_NAME).zip"
          Invoke-WebRequest -Headers $headers -Uri $zipUrl -OutFile $zipPath

          # 3) Extract ZIP and verify expected file exists
          Expand-Archive -Path $zipPath -DestinationPath "$env:GITHUB_WORKSPACE\work" -Force
          Remove-Item $zipPath -Force

          $expected = Join-Path "$env:GITHUB_WORKSPACE\work" $env:ART_NAME
          if (-not (Test-Path $expected)) {
            throw "Download/extract succeeded but '$($env:ART_NAME)' not found in work/."
          }

          Write-Host "Downloaded and verified: $expected"
          Get-ChildItem "$env:GITHUB_WORKSPACE\work" -Recurse | ForEach-Object { Write-Host $_.FullName }
