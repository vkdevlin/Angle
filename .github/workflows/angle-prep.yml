name: angle-prep

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "Run ID that produced the artifact (e.g., 19175891700)"
        required: true
        type: string
      artifact_name:
        description: "Exact artifact name (case-sensitive)"
        required: true
        default: angle-src.tgz
        type: string

permissions:
  actions: read      # <-- REQUIRED to read artifacts from another run
  contents: read

jobs:
  prep:
    runs-on: windows-latest

    steps:
      - name: Show workspace and inputs
        shell: pwsh
        run: |
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          Write-Host "Run ID:  ${{ inputs.run_id }}"
          Write-Host "Artifact: ${{ inputs.artifact_name }}"

      - name: Download artifact via gh CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          mkdir work | Out-Null
          gh run download ${{ inputs.run_id }} --name "${{ inputs.artifact_name }}" --dir work

      - name: Verify file exists
        shell: pwsh
        run: |
          $p = Join-Path $env:GITHUB_WORKSPACE "work\${{ inputs.artifact_name }}"
          if (-not (Test-Path $p)) { throw "Artifact file not found at $p" }
          Get-ChildItem $p | Format-List Name, Length, FullName

      - name: List work dir
        shell: pwsh
        run: |
          Get-ChildItem -Force work | Format-Table -Auto
