name: angle-prep (download prior artifact)

on:
  workflow_dispatch: {}   # manual only

permissions:
  contents: read
  actions: read

jobs:
  prep:
    runs-on: windows-latest
    env:
      RUN_ID: '19175891700'          # <- your successful fetch run id
      ARTIFACT_NAME: 'angle-src.tgz' # <- exact artifact name shown in Actions UI

    steps:
      - name: Show workspace and inputs
        shell: pwsh
        run: |
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          Write-Host "Run ID:    $env:RUN_ID"
          Write-Host "Artifact:  $env:ARTIFACT_NAME"

      - name: Authenticate gh
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh --version
          gh auth status 2>$null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Logging into gh with GITHUB_TOKENâ€¦"
            $env:GITHUB_TOKEN | gh auth login --with-token
          }
          gh auth status

      - name: Download artifact from specified run
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\work" | Out-Null
          gh run download --repo "$env:GITHUB_REPOSITORY" --run-id "$env:RUN_ID" -n "$env:ARTIFACT_NAME" -D "$env:GITHUB_WORKSPACE\work"
          if (-not (Test-Path "$env:GITHUB_WORKSPACE\work\$env:ARTIFACT_NAME")) {
            throw "Download did not produce $env:ARTIFACT_NAME in work\"
          }
          $f = Get-Item "$env:GITHUB_WORKSPACE\work\$env:ARTIFACT_NAME"
          Write-Host "Downloaded: $($f.FullName)"
          Write-Host ("Size (bytes): {0}" -f $f.Length)
