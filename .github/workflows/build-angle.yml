name: Build ANGLE for Windows x64 (robust)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure Python (for gn/gclient hooks)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install depot_tools
        shell: bash
        run: |
          set -e
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$PWD/depot_tools" >> $GITHUB_PATH

      - name: Harden Git for large/slow networks
        shell: bash
        run: |
          git config --global core.longpaths true
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 0

      - name: Fetch ANGLE (with retries)
        shell: bash
        run: |
          set -e
          mkdir angle && cd angle
          # Initial fetch can flake; retry a few times
          for i in 1 2 3; do
            if fetch angle; then
              break
            fi
            echo "fetch angle failed (attempt $i). Sleeping 60s and retrying..."
            sleep 60
          done

      - name: Sync deps (gclient sync, with retries)
        shell: bash
        run: |
          set -e
          cd angle
          for i in 1 2 3 4 5; do
            if GCLIENT_VERBOSE=1 gclient sync --nohooks --no-history --shallow --jobs 2; then
              break
            fi
            echo "gclient sync failed (attempt $i). Sleeping 90s and retrying..."
            sleep 90
          done

      - name: Run hooks (with retries)
        shell: bash
        run: |
          set -e
          cd angle
          for i in 1 2 3; do
            if gclient runhooks; then
              break
            fi
            echo "gclient runhooks failed (attempt $i). Sleeping 30s and retrying..."
            sleep 30
          done

      - name: Generate build files (Release x64, D3D11)
        shell: bash
        run: |
          set -e
          cd angle
          gn gen out/Win64Rel --args="is_debug=false is_component_build=false angle_enable_d3d11=true target_cpu=\"x64\""

      - name: Build ANGLE (libEGL, libGLESv2)
        shell: bash
        run: |
          set -e
          cd angle
          autoninja -C out/Win64Rel libEGL libGLESv2

      - name: Package artifact (headers + DLLs + LIBs)
        shell: bash
        run: |
          set -e
          cd angle
          pkg="out/pkg_x64"
          mkdir -p "$pkg/include"
          cp -R include/* "$pkg/include/"
          cp out/Win64Rel/libEGL.dll     "$pkg/"
          cp out/Win64Rel/libGLESv2.dll  "$pkg/"
          cp out/Win64Rel/libEGL.lib     "$pkg/"
          cp out/Win64Rel/libGLESv2.lib  "$pkg/"
          cd out && tar -a -c -f angle-windows-x64-release.zip "pkg_x64"

      - name: Upload ANGLE x64 Release
        uses: actions/upload-artifact@v4
        with:
          name: angle-windows-x64-release
          path: angle/out/angle-windows-x64-release.zip
