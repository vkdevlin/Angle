name: Build ANGLE 7

on:
  workflow_dispatch:

jobs:
  build-angle:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure environment
        shell: pwsh
        run: |
          # Use the runner's installed Visual Studio toolchain
          "DEPOT_TOOLS_WIN_TOOLCHAIN=0" | Out-File -FilePath $env:GITHUB_ENV -Append

          # Stable work directory
          $work = Join-Path $env:GITHUB_WORKSPACE 'work'
          if (-not (Test-Path $work)) { New-Item -ItemType Directory -Path $work | Out-Null }
          "WORK_DIR=$work" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install depot_tools and add to PATH
        shell: pwsh
        run: |
          $depot = Join-Path $env:GITHUB_WORKSPACE 'depot_tools'
          if (-not (Test-Path $depot)) {
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $depot
          }
          $depot | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Fetch or reuse ANGLE
        shell: pwsh
        working-directory: ${{ env.WORK_DIR }}
        run: |
          if (-not (Test-Path angle)) {
            fetch angle
          }
          Set-Location angle
          # If fetch was skipped, make sure .gclient exists; if not, configure explicitly
          if (-not (Test-Path ".gclient")) {
            gclient config https://chromium.googlesource.com/angle/angle.git
          }
          gclient sync -D
          gclient runhooks

      - name: Generate build files (GN)
        shell: pwsh
        working-directory: ${{ env.WORK_DIR }}\angle
        run: |
          if (-not (Test-Path ".gn")) { throw "Missing .gn at ANGLE root." }
          gn gen out/Win64Rel --args='is_debug=false is_component_build=false target_cpu="x64" angle_enable_vulkan=false'

      - name: Build ANGLE
        shell: pwsh
        working-directory: ${{ env.WORK_DIR }}\angle
        run: |
          autoninja -C out/Win64Rel libEGL libGLESv2

      - name: Package artifact
        shell: pwsh
        working-directory: ${{ env.WORK_DIR }}\angle
        run: |
          $dest = Join-Path $env:GITHUB_WORKSPACE 'artifact'
          New-Item -ItemType Directory -Force -Path "$dest\include" | Out-Null
          New-Item -ItemType Directory -Force -Path "$dest\lib"     | Out-Null
          Copy-Item -Recurse -Force ".\include\*"                   "$dest\include\"
          Copy-Item -Force ".\out\Win64Rel\libEGL.dll"              "$dest\lib\"
          Copy-Item -Force ".\out\Win64Rel\libGLESv2.dll"           "$dest\lib\"
          Get-ChildItem ".\out\Win64Rel" -Filter "*.lib" | Copy-Item -Destination "$dest\lib\" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: angle-windows-x64
          path: artifact
